<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ListElf - ê·œì¹™ ê´€ë¦¬</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />

  <style>
        :root {
        --scdms-gold: #F5C542;
        --scdms-gold-dark: #D9A620;
        --scdms-gold-bg: #FFF7D6;
        }

        body {
        background: radial-gradient(circle at top, #FFF7D6 0, #FFF7D6 45%, #FFF7D6 100%);
        min-height: 100vh;
        }

        /* ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ */
        .scdms-navbar {
        background: var(--scdms-gold);
        }
        .scdms-navbar .navbar-brand {
        font-weight: 700;
        }
        .scdms-navbar .brand-icon {
        margin-right: 6px;
        }

        /* ìƒë‹¨ íƒ­ */
        .scdms-tabs {
        background: var(--scdms-gold-bg);
        border-bottom: 1px solid #E8D9A8;
        }
        .scdms-tabs .nav-link {
        border-radius: 999px;
        padding: 8px 20px;
        margin-right: 8px;
        font-weight: 600;
        color: #555;
        }
        .scdms-tabs .nav-link.active {
        background: var(--scdms-gold);
        color: #fff;
        }

        /* ë©”ì¸ ì¹´ë“œ */
        .scdms-card {
        background: #ffffff;
        border-radius: 18px;
        border: 1px solid #f0f0f0;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.04);
        }

        .section-title {
        font-weight: 700;
        font-size: 1.1rem;
        }

        .rule-row-title {
        font-weight: 600;
        }

        .text-meta {
        font-size: 0.8rem;
        color: #888;
        }

        /* ë©”ì¸ ë²„íŠ¼ */
        .btn-main {
        background: var(--scdms-gold);
        border-color: var(--scdms-gold);
        }
        .btn-main:hover {
        background: var(--scdms-gold-dark);
        border-color: var(--scdms-gold-dark);
        }

        .rules-empty {
        text-align: center;
        padding: 24px 0;
        color: #999;
        font-size: 0.95rem;
        }
  </style>

  <script src="/js/auth.js"></script>
  <script>
    const currentUser = requireRole(["ListElf"]);
  </script>
</head>

<body>
<nav class="navbar navbar-expand-lg navbar-dark scdms-navbar">
  <div class="container-fluid px-4">
    <a class="navbar-brand d-flex align-items-center" href="#">
      <span class="brand-icon">ğŸ„</span>
      <span>SCDMS Â· ëª…ë‹¨ ê´€ë¦¬ ìš”ì²­ ì œì–´ì„¼í„°</span>
    </a>
    
    <div class="d-flex align-items-center gap-3">
        <div class="text-end lh-1">
            <div id="header-user-name" class="text-white fw-bold small mb-1">
                ì‚¬ìš©ì
            </div>
            <span id="header-user-role" class="badge bg-light text-dark rounded-pill" style="font-size: 0.7rem;">
                ListElf
            </span>
        </div>
        <button type="button" class="btn btn-outline-light btn-sm" id="btn-logout">
            ë¡œê·¸ì•„ì›ƒ
        </button>
    </div>
  </div>
</nav>

<div class="scdms-tabs">
  <div class="container px-4">
    <ul class="nav py-3">
      <li class="nav-item">
        <a class="nav-link" href="/list_elf.html">ì•„ì´ ëª©ë¡</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/add_child.html">ì•„ì´ ë“±ë¡</a>
      </li>
      <li class="nav-item">
        <a class="nav-link active" href="/rules.html">ê·œì¹™ ê´€ë¦¬</a>
      </li>
    </ul>
  </div>
</div>

<div class="container px-4 py-4">
  <div class="scdms-card p-4 p-md-5">

    <div class="mb-4">
      <h2 class="fw-bold mb-1">ê·œì¹™ ê´€ë¦¬</h2>
      <p class="text-muted mb-0">
        ì•„ì´ë¥¼ ì°©í•œ/ë‚˜ìœ ì•„ì´ë¡œ ë¶„ë¥˜í•  ë•Œ ì°¸ê³ í•˜ëŠ” ê¸°ì¤€ ë¬¸êµ¬ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤. (ìš´ì˜ ì°¸ê³ ìš©)
      </p>
    </div>

    <div class="mb-4">
      <div class="section-title mb-2">â• ìƒˆ ê·œì¹™ ë§Œë“¤ê¸°</div>
      <p class="text-muted mb-3 small">ì œëª©ê³¼ ìƒì„¸ ê¸°ì¤€ì„ ì…ë ¥í•˜ê³  ê·œì¹™ì„ ì¶”ê°€í•˜ì„¸ìš”.</p>

      <div class="mb-3">
        <label class="form-label">ê·œì¹™ ì œëª© *</label>
        <input id="ruleTitle" class="form-control" placeholder="ì˜ˆ: í¸ì‹ ì•ˆí•¨ì´" />
      </div>

      <div class="mb-3">
        <label class="form-label">ê·œì¹™ ìƒì„¸ ê¸°ì¤€ *</label>
        <textarea id="ruleDescription" class="form-control" rows="3"
                  placeholder="ì˜ˆ: ìµœê·¼ í•œ ë‹¬ê°„ ì•¼ì±„ë¥¼ ì—„ì²­ ë§ì´ ë¨¹ìŒ"></textarea>
      </div>

      <div class="text-end">
        <button class="btn btn-main" onclick="createRule()">+ ê·œì¹™ ì¶”ê°€</button>
      </div>
    </div>

    <hr class="my-4" />

    <div>
      <div class="section-title mb-2">ğŸ“– í™œì„± ê·œì¹™</div>
      <p class="text-muted mb-3 small">í˜„ì¬ ìš´ì˜ ì¤‘ì¸ ë¶„ë¥˜ ê¸°ì¤€ë“¤ì…ë‹ˆë‹¤.</p>

      <div id="rulesContainer">
        </div>
    </div>

  </div>
</div>

<div class="modal fade" id="ruleDetailModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">ê·œì¹™ ìƒì„¸ë³´ê¸°</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <h5 id="detailTitle" class="fw-bold mb-2"></h5>
        <p class="text-meta mb-3" id="detailMeta"></p>

        <div class="mb-2 fw-semibold">ìƒì„¸ ì„¤ëª…</div>
        <pre id="detailDescription"
             style="white-space: pre-wrap; font-family: inherit; font-size: 0.95rem;"></pre>
      </div>

      <div class="modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
        <button class="btn btn-main" onclick="openEditModal()">ìˆ˜ì •í•˜ê¸°</button>
      </div>

    </div>
  </div>
</div>

<div class="modal fade" id="ruleEditModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">ê·œì¹™ ìˆ˜ì •</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">ê·œì¹™ ì œëª©</label>
          <input id="editTitle" class="form-control" />
        </div>
        <div class="mb-3">
          <label class="form-label">ê·œì¹™ ìƒì„¸ ê¸°ì¤€</label>
          <textarea id="editDescription" class="form-control" rows="4"></textarea>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
        <button class="btn btn-main" onclick="saveRuleEdit()">ì €ì¥</button>
      </div>

    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
  const BASE_URL = "http://127.0.0.1:8000";

  let rules = [];
  let currentRuleId = null; // ìƒì„¸ë³´ê¸° / ìˆ˜ì • ëŒ€ìƒ rule_id

  /* -------------------------------
     ì‚¬ìš©ì ì •ë³´ ì´ˆê¸°í™”
  -------------------------------- */
  function initUserInfo() {
    const raw = localStorage.getItem("currentUser");
    if (!raw) return;

    try {
        const user = JSON.parse(raw);
        
        const nameEl = document.getElementById("header-user-name");
        if (nameEl) nameEl.textContent = `${user.name || "ì´ë¦„ ì—†ìŒ"} ìš”ì •`;

        const roleEl = document.getElementById("header-user-role");
        if (roleEl) roleEl.textContent = user.role || "ListElf";

    } catch (e) {
        console.warn("ì‚¬ìš©ì ì •ë³´ íŒŒì‹± ì‹¤íŒ¨", e);
    }
  }

  /* -------------------------------
     ë¡œê·¸ì•„ì›ƒ
  -------------------------------- */
  function initLogout() {
    const btn = document.getElementById("btn-logout");
    if (btn) {
        btn.addEventListener("click", (e) => {
            e.preventDefault();

            if (!confirm("ì •ë§ ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                return; 
            }

            if (typeof logout === "function") {
                logout();
            } else {
                localStorage.removeItem("currentUser");
                localStorage.removeItem("token");
                window.location.href = "../index.html";
            }
        });
    }
  }

  /* -------------------------------
     Staff ID ê°€ì ¸ì˜¤ê¸°
  -------------------------------- */
  function getStaffId() {
    const raw = localStorage.getItem("currentUser");
    if (!raw) return null;
    try {
        const user = JSON.parse(raw);
        return user.staff_id || null;
    } catch(e) {
        return null;
    }
  }

  /* ê·œì¹™ ìƒì„± */
  async function createRule() {
    const title = document.getElementById("ruleTitle").value.trim();
    const description = document.getElementById("ruleDescription").value.trim();
    const staffId = getStaffId();

    if (!title || !description) {
      alert("ê·œì¹™ ì œëª©ê³¼ ìƒì„¸ ê¸°ì¤€ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }

    if (!staffId) {
        alert("ë¡œê·¸ì¸ ì •ë³´(staff_id)ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }

    const body = {
      title,
      description,
      created_by_staff_id: staffId
    };

    try {
      const res = await fetch(`${BASE_URL}/list-elf/rules/create`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });

      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        alert("ê·œì¹™ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n" + (err.detail || ""));
        return;
      }

      document.getElementById("ruleTitle").value = "";
      document.getElementById("ruleDescription").value = "";
      await loadRules();
    } catch (e) {
      console.error(e);
      alert("ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  }

  /* ğŸ“¥ ê·œì¹™ ì „ì²´ ì¡°íšŒ */
  async function loadRules() {
    try {
      const res = await fetch(`${BASE_URL}/list-elf/rules/all`);
      rules = await res.json();
      renderRules();
    } catch (e) {
      console.error(e);
      alert("ê·œì¹™ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  }

  /* ğŸ–¼ ê·œì¹™ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ */
  function renderRules() {
    const container = document.getElementById("rulesContainer");
    container.innerHTML = "";

    if (!rules || rules.length === 0) {
      container.innerHTML = `<div class="rules-empty">ë“±ë¡ëœ ê·œì¹™ì´ ì—†ìŠµë‹ˆë‹¤. ìœ„ì—ì„œ ìƒˆ ê·œì¹™ì„ ì¶”ê°€í•´ ì£¼ì„¸ìš”.</div>`;
      return;
    }

    const table = document.createElement("table");
    table.className = "table align-middle mb-0";

    const thead = document.createElement("thead");
    thead.innerHTML = `
      <tr class="table-secondary">
        <th style="width: 70px;">ID</th>
        <th>ì œëª©</th>
        <th style="width: 130px;">ì‘ì„±ì</th>
        <th style="width: 170px;">ìƒì„±ì¼</th>
        <th style="width: 180px;">ê·œì¹™ ë‚´ìš©</th>
      </tr>
    `;

    const tbody = document.createElement("tbody");

    rules.forEach(rule => {
      const tr = document.createElement("tr");

      const createdAt = formatDate(rule.created_at);

      tr.innerHTML = `
        <td>${rule.rule_id}</td>
        <td class="rule-row-title">${escapeHtml(rule.title)}</td>
        <td>${rule.created_by_staff_id}</td>
        <td>${createdAt}</td>
        <td>
          <button class="btn btn-sm btn-outline-primary me-1"
                  onclick="openRuleDetail(${rule.rule_id})">
            ìƒì„¸ë³´ê¸°
          </button>
          <button class="btn btn-sm btn-outline-danger"
                  onclick="deleteRule(${rule.rule_id})">
            ğŸ—‘
          </button>
        </td>
      `;

      tbody.appendChild(tr);
    });

    table.appendChild(thead);
    table.appendChild(tbody);
    container.appendChild(table);
  }

  /* ğŸ“„ ê·œì¹™ ìƒì„¸ ë³´ê¸° ëª¨ë‹¬ ì—´ê¸° */
  function openRuleDetail(ruleId) {
    const rule = rules.find(r => r.rule_id === ruleId);
    if (!rule) return;

    currentRuleId = ruleId;

    const titleEl = document.getElementById("detailTitle");
    const metaEl = document.getElementById("detailMeta");
    const descEl = document.getElementById("detailDescription");

    titleEl.textContent = rule.title;

    const createdAt = formatDate(rule.created_at);
    const updatedAt = formatDate(rule.updated_at);

    let meta = `ì‘ì„±ì: #${rule.created_by_staff_id} Â· ìƒì„±: ${createdAt}`;
    if (rule.updated_by_staff_id) {
      meta += `\nìˆ˜ì •ì: #${rule.updated_by_staff_id} Â· ìˆ˜ì •: ${updatedAt}`;
    } else {
      meta += `\nìˆ˜ì • ê¸°ë¡ ì—†ìŒ`;
    }
    metaEl.textContent = meta;

    descEl.textContent = rule.description || "";

    const modalEl = document.getElementById("ruleDetailModal");
    const modal = new bootstrap.Modal(modalEl);
    modal.show();
  }

  /* âœ ìƒì„¸ë³´ê¸°ì—ì„œ ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸° */
  function openEditModal() {
    const rule = rules.find(r => r.rule_id === currentRuleId);
    if (!rule) return;

    document.getElementById("editTitle").value = rule.title;
    document.getElementById("editDescription").value = rule.description;

    const detailModalEl = document.getElementById("ruleDetailModal");
    const detailModal = bootstrap.Modal.getInstance(detailModalEl);
    if (detailModal) detailModal.hide();

    const editModalEl = document.getElementById("ruleEditModal");
    const editModal = new bootstrap.Modal(editModalEl);
    editModal.show();
  }

  /* ğŸ’¾ ê·œì¹™ ìˆ˜ì • ì €ì¥ */
  async function saveRuleEdit() {
    const title = document.getElementById("editTitle").value.trim();
    const description = document.getElementById("editDescription").value.trim();
    const staffId = getStaffId();

    if (!title || !description) {
      alert("ê·œì¹™ ì œëª©ê³¼ ìƒì„¸ ê¸°ì¤€ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }
    
    if (!staffId) {
        alert("ë¡œê·¸ì¸ ì •ë³´(staff_id)ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }

    const body = {
      title,
      description,
      updated_by_staff_id: staffId
    };

    try {
      const res = await fetch(`${BASE_URL}/list-elf/rules/update/${currentRuleId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });

      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        alert("ê·œì¹™ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n" + (err.detail || ""));
        return;
      }

      const editModalEl = document.getElementById("ruleEditModal");
      const editModal = bootstrap.Modal.getInstance(editModalEl);
      if (editModal) editModal.hide();

      await loadRules();
    } catch (e) {
      console.error(e);
      alert("ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  }

  /* ğŸ—‘ ê·œì¹™ ì‚­ì œ */
  async function deleteRule(ruleId) {
    if (!confirm("í•´ë‹¹ ê·œì¹™ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    try {
      const res = await fetch(`${BASE_URL}/list-elf/rules/${ruleId}`, {
        method: "DELETE"
      });

      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        alert("ê·œì¹™ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n" + (err.detail || ""));
        return;
      }

      await loadRules();
    } catch (e) {
      console.error(e);
      alert("ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  }

  /* ìœ í‹¸: ë‚ ì§œ í¬ë§· */
  function formatDate(value) {
    if (!value) return "-";
    const d = new Date(value);
    if (isNaN(d.getTime())) return value;
    return d.toLocaleString("ko-KR");
  }

  /* ìœ í‹¸: XSS ë°©ì§€ìš© ê°„ë‹¨ escape */
  function escapeHtml(str) {
    if (str == null) return "";
    return String(str)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  /* ì´ˆê¸° ì‹¤í–‰ */
  (async function init() {
    initUserInfo();
    initLogout();
    await loadRules();
  })();
</script>

</body>
</html>