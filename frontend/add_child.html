<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ListElf - ì•„ì´ ë“±ë¡</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />

    <style>
        :root {
            --scdms-gold: #F5C542;
            --scdms-gold-dark: #D9A620;
            --scdms-gold-bg: #FFF7D6;
        }

        body {
            background: radial-gradient(circle at top, #FFF7D6 0, #FFF7D6 45%, #FFF7D6 100%);
            min-height: 100vh;
        }

        /* ìƒë‹¨ ë„¤ë¹„ */
        .scdms-navbar {
            background: var(--scdms-gold);
        }
        .scdms-navbar .navbar-brand {
            font-weight: 700;
        }
        .scdms-navbar .brand-icon {
            margin-right: 6px;
        }

        /* ìƒë‹¨ íƒ­ */
        .scdms-tabs {
            background: var(--scdms-gold-bg);
            border-bottom: 1px solid #E8D9A8;
        }
        .scdms-tabs .nav-link {
            border-radius: 999px;
            padding: 8px 20px;
            margin-right: 8px;
            font-weight: 600;
            color: #555;
        }
        .scdms-tabs .nav-link.active {
            background: var(--scdms-gold);
            color: #fff;
        }

        /* ë©”ì¸ ì¹´ë“œ */
        .scdms-card {
            background: #ffffff;
            border-radius: 18px;
            border: 1px solid #f0f0f0;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.04);
        }

        .section-title {
            font-weight: 700;
            font-size: 1.15rem;
        }

        .wishlist-item {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
        }
        .wishlist-item select,
        .wishlist-item input {
            flex: 1;
        }

        /* ë²„íŠ¼ */
        .btn-main {
            background: var(--scdms-gold);
            border-color: var(--scdms-gold);
        }
        .btn-main:hover {
            background: var(--scdms-gold-dark);
            border-color: var(--scdms-gold-dark);
        }

    </style>
</head>

<body>
<!--ìƒë‹¨ ê¸€ë¡œë²Œ ë„¤ë¹„ê²Œì´ì…˜ -->
<nav class="navbar navbar-expand-lg navbar-dark scdms-navbar">
    <div class="container-fluid px-4">
        <a class="navbar-brand d-flex align-items-center" href="#">
            <span class="brand-icon">ğŸ„</span>
            <span>SCDMS Â· ëª…ë‹¨ ê´€ë¦¬ ìš”ì²­ ì œì–´ì„¼í„°</span>
        </a>
        <div class="d-flex align-items-center">
            <span class="badge bg-light text-dark me-3">ListElf</span>
            <a href="/login.html" class="btn btn-outline-light btn-sm">ë¡œê·¸ì•„ì›ƒ</a>
        </div>
    </div>
</nav>

<!--ìƒë‹¨ íƒ­ (ì—­í•  ë‚´ ë©”ë‰´) -->
<div class="scdms-tabs">
    <div class="container px-4">
        <ul class="nav py-3">
            <li class="nav-item">
                <a class="nav-link" href="/list_elf.html">ì•„ì´ ëª©ë¡</a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" href="/add_child.html">ì•„ì´ ë“±ë¡</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/rules.html">ê·œì¹™ ê´€ë¦¬</a>
            </li>
        </ul>
    </div>
</div>

<!-- ë©”ì¸ ì½˜í…ì¸  -->
<div class="container px-4 py-4">
    <div class="scdms-card p-4 p-md-5">

        <div class="d-flex align-items-center mb-4">
            <h2 class="fw-bold mb-0">ìƒˆ ì•„ì´ ë“±ë¡</h2>
            <span class="ms-2 text-muted small">ë…¸ìŠ¤í´ ë“±ë¡ë¶€ì— ìƒˆë¡œìš´ ì•„ì´ë¥¼ ì¶”ê°€í•´ìš”.</span>
        </div>

        <!-- ì´ë¦„ + ì£¼ì†Œ -->
        <div class="row mb-3">
            <div class="col-md-6 mb-3 mb-md-0">
                <label class="form-label">ì•„ì´ ì´ë¦„ *</label>
                <input id="name" class="form-control" placeholder="ì˜ˆ: ê¹€ë¯¼ìˆ˜" required>
            </div>
            <div class="col-md-6">
                <label class="form-label">ì£¼ì†Œ *</label>
                <input id="address" class="form-control" placeholder="ì˜ˆ: ì„œìš¸ì‹œ ê°•ë‚¨êµ¬" required>
            </div>
        </div>

        <!-- ì§€ì—­ -->
        <div class="mb-3">
            <label class="form-label">ì§€ì—­ *</label>
            <select id="region" class="form-select"></select>
        </div>

        <!-- ì„¤ëª… -->
        <div class="mb-4">
            <label class="form-label">ì•„ì´ ì„¤ëª… (child_note)</label>
            <textarea id="note" rows="3" class="form-control" placeholder="ì˜ˆ: ê³µë£¡ ì¢‹ì•„í•¨, ë‘˜ì§¸ ì•„ì´"></textarea>
        </div>

        <!-- Wishlist -->
        <div class="mb-2 d-flex align-items-center justify-content-between">
            <span class="section-title">ìœ„ì‹œë¦¬ìŠ¤íŠ¸ *</span>
            <small class="text-muted" id="wishlistHint">ì„ ë¬¼ ì¢…ë¥˜ ìˆ˜ë§Œí¼ë§Œ ì¶”ê°€í•  ìˆ˜ ìˆì–´ìš”.</small>
        </div>

        <div id="wishlistContainer" class="mb-2"></div>

        <button class="btn btn-outline-secondary btn-sm mb-4" type="button" onclick="addWishlistItem()">
            + ì†Œì› ì¶”ê°€í•˜ê¸°
        </button>

        <hr />

        <!-- ì œì¶œ -->
        <button class="btn btn-main w-100 py-2" onclick="submitChild()">ğŸ„ ì•„ì´ ë“±ë¡í•˜ê¸°</button>
    </div>
</div>

<script>
const BASE_URL = "http://127.0.0.1:8000";

let gifts = [];

/* -------------------------------
   1ï¸. ì„ ë¬¼ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
-------------------------------- */
async function loadGifts() {
    const res = await fetch(`${BASE_URL}/gift/`);
    gifts = await res.json();

    // íŒíŠ¸ í…ìŠ¤íŠ¸ì— ìµœëŒ€ ê°œìˆ˜ í‘œì‹œ
    const hint = document.getElementById("wishlistHint");
    if (gifts.length > 0) {
        hint.textContent = `ìœ„ì‹œë¦¬ìŠ¤íŠ¸ëŠ” ìµœëŒ€ ${gifts.length}ê°œê¹Œì§€ ì¶”ê°€í•  ìˆ˜ ìˆì–´ìš”.`;
    } else {
        hint.textContent = "ë“±ë¡ ê°€ëŠ¥í•œ ì„ ë¬¼ì´ ì•„ì§ ì—†ì–´ìš”.";
    }
}

/* -------------------------------
   2ï¸. ì§€ì—­ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
-------------------------------- */
async function loadRegions() {
    const res = await fetch(`${BASE_URL}/regions/all`);
    const regions = await res.json();

    const select = document.getElementById("region");
    select.innerHTML = "";

    regions.forEach(r => {
        const opt = document.createElement("option");
        opt.value = r.RegionID;
        opt.textContent = r.RegionName;
        select.appendChild(opt);
    });
}

/* -------------------------------
   3ï¸. wishlist ì…ë ¥í–‰ ì¶”ê°€
   - ê¸°ì¡´ ì„ íƒê°’ì´ ì´ˆê¸°í™”ë˜ì§€ ì•Šë„ë¡
   - gifts.length ê°œìˆ˜ê¹Œì§€ë§Œ ì¶”ê°€
-------------------------------- */
function addWishlistItem() {
    const container = document.getElementById("wishlistContainer");

    // ìµœëŒ€ ê°œìˆ˜ ì œí•œ
    const currentCount = container.querySelectorAll(".wishlist-item").length;
    if (currentCount >= gifts.length) {
        alert(`ìœ„ì‹œë¦¬ìŠ¤íŠ¸ëŠ” ìµœëŒ€ ${gifts.length}ê°œê¹Œì§€ë§Œ ì¶”ê°€í•  ìˆ˜ ìˆì–´ìš”!`);
        return;
    }

    // ğŸ” í˜„ì¬ ì‚¬ìš©ëœ ìš°ì„ ìˆœìœ„ ëª©ë¡
    const usedPriorities = Array.from(
        document.querySelectorAll(".wishlist-item .priority")
    ).map(input => parseInt(input.value))
     .filter(v => !isNaN(v));

    // ğŸ”¢ ê¸°ë³¸ ë„£ì„ ìš°ì„ ìˆœìœ„ = ì‚¬ìš©ë˜ì§€ ì•Šì€ ê°€ì¥ ì‘ì€ ë²ˆí˜¸
    let defaultPriority = 1;
    while (usedPriorities.includes(defaultPriority)) {
        defaultPriority++;
    }

    // DOM ìƒì„±
    const row = document.createElement("div");
    row.className = "wishlist-item";

    const giftSelect = document.createElement("select");
    giftSelect.className = "form-select gift-id";

    gifts.forEach(g => {
        const opt = document.createElement("option");
        opt.value = g.gift_id;
        opt.textContent = `${g.gift_id} - ${g.gift_name}`;
        giftSelect.appendChild(opt);
    });

    const priorityInput = document.createElement("input");
    priorityInput.className = "form-control priority";
    priorityInput.placeholder = "ìš°ì„ ìˆœìœ„ (1 ~ n)";
    priorityInput.value = defaultPriority;    

    // ì‹¤ì‹œê°„ ì¤‘ë³µ ë°©ì§€ ì´ë²¤íŠ¸ ì¶”ê°€
    priorityInput.addEventListener("change", validatePriorities);

    row.appendChild(giftSelect);
    row.appendChild(priorityInput);

    container.appendChild(row);
}

/*------------
ì¤‘ë³µ priority ê²€ì¦ í•¨ìˆ˜ ì¶”ê°€

ì‚¬ìš©ìê°€ priority ê°’ì„ ë³€ê²½í•  ë•Œ
->ì¤‘ë³µë˜ë©´ ì›ë˜ ê°’ìœ¼ë¡œ ë˜ëŒë¦¬ê³  alert

priority ê°’ì´ ë²”ìœ„ë¥¼ ë²—ì–´ë‚˜ë©´ ìë™ ì¡°ì •
(ì˜ˆ: 0 â†’ 1, 99 â†’ gifts.length)
---------------- */
function validatePriorities() {
    const priorityInputs = Array.from(document.querySelectorAll(".priority"));

    // ëª¨ë“  ê°’ ì½ê¸°
    let values = priorityInputs.map(i => parseInt(i.value) || 1);

    // ë²”ìœ„ ë³´ì •: 1 ~ ì„ ë¬¼ ê°œìˆ˜
    values = values.map(v => {
        if (v < 1) return 1;
        if (v > gifts.length) return gifts.length;
        return v;
    });

    // ì¤‘ë³µ ê²€ì‚¬
    const duplicates = values.filter((v, i, arr) => arr.indexOf(v) !== i);

    if (duplicates.length > 0) {
        alert("ìš°ì„ ìˆœìœ„ëŠ” ì¤‘ë³µë  ìˆ˜ ì—†ì–´ìš”! (1 ~ n ê° 1íšŒë§Œ ê°€ëŠ¥)");

        // ì…ë ¥ ë˜ëŒë¦¬ê¸°
        priorityInputs.forEach((input, i) => {
            input.value = i + 1 <= gifts.length ? i + 1 : gifts.length;
        });
    }
}


/* -------------------------------
   4. ì•„ì´ ë“±ë¡ ìš”ì²­
-------------------------------- */
async function submitChild() {
    const name = document.getElementById("name").value.trim();
    const address = document.getElementById("address").value.trim();
    const region_id = parseInt(document.getElementById("region").value);
    const child_note = document.getElementById("note").value;

    
    if (!name || !address) {
        alert("ì´ë¦„ê³¼ ì£¼ì†ŒëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.");
        return;
    }

    const wishlist = [];
    const priorityInputs = document.querySelectorAll(".wishlist-item .priority");
    const priorities = Array.from(priorityInputs).map(i => parseInt(i.value));

    // ì¤‘ë³µ ê²€ì‚¬
    const hasDuplicate = priorities.some(
        (p, idx) => priorities.indexOf(p) !== idx
    );

    if (hasDuplicate) {
        alert("ìœ„ì‹œë¦¬ìŠ¤íŠ¸ ìš°ì„ ìˆœìœ„ê°€ ì¤‘ë³µë˜ì—ˆì–´ìš”. ì„œë¡œ ë‹¤ë¥¸ ë²ˆí˜¸ë¡œ ì„¤ì •í•´ì£¼ì„¸ìš”!");
        return;
    }
    document.querySelectorAll(".wishlist-item").forEach(row => {
        const gift_id = parseInt(row.querySelector(".gift-id").value);
        const priority = parseInt(row.querySelector(".priority").value) || 1;
        wishlist.push({ gift_id, priority });
    });

    const body = {
        name,
        address,
        region_id,
        child_note,
        wishlist
    };

    const res = await fetch(`${BASE_URL}/list-elf/child/create`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
    });

    if (res.ok) {
        alert("ì•„ì´ ë“±ë¡ ì™„ë£Œ! ğŸ");
        window.location.href = "/list_elf.html";
    } else {
        alert("ë“±ë¡ ì‹¤íŒ¨â€¦ ì„œë²„ ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”!");
    }
}

/* -------------------------------
   ì´ˆê¸° ì‹¤í–‰
-------------------------------- */
(async function init() {
    await loadGifts();
    await loadRegions();
    addWishlistItem(); // ê¸°ë³¸ 1ê°œ ì¶”ê°€
})();
</script>

</body>
</html>