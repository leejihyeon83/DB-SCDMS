<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ListElf - ì•„ì´ ëª©ë¡</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>

    <style>
        body { background-color: #f7f9f7; }
        .priority-1 { background: #fff3cd; }
        .priority-2 { background: #e2e3e5; }
        .priority-3 { background: #d4edda; }
    </style>
</head>

<body>

<div class="container py-4">

    <h2 class="mb-4 fw-bold">ğŸ„ ListElf â€“ ì•„ì´ ëª©ë¡</h2>

    <!-- ê²€ìƒ‰ + ì§€ì—­ í•„í„° -->
    <div class="row mb-3">
        <div class="col-6">
            <input id="searchInput" class="form-control" placeholder="ì´ë¦„ ë˜ëŠ” ì£¼ì†Œ ê²€ìƒ‰â€¦" />
        </div>
        <div class="col-3">
            <select id="regionFilter" class="form-select" onchange="renderChildren()">
                <option value="">ì „ì²´ ì§€ì—­</option>
            </select>
        </div>
        <div class="col-3">
            <button class="btn btn-secondary w-100" onclick="loadChildren()">ê²€ìƒ‰</button>
        </div>
    </div>

    <!-- ìš”ì•½ íŒ¨ë„ -->
    <div class="row mb-4">
        <div class="col">
            <div class="p-3 bg-light border rounded">ì°©í•œ ì•„ì´: <span id="countNice">0</span></div>
        </div>
        <div class="col">
            <div class="p-3 bg-light border rounded">ë‚˜ìœ ì•„ì´: <span id="countNaughty">0</span></div>
        </div>
        <div class="col">
            <div class="p-3 bg-light border rounded">ì‹¬ì‚¬ ëŒ€ê¸°: <span id="countPending">0</span></div>
        </div>
    </div>

    <!-- ì•„ì´ í…Œì´ë¸” -->
    <table class="table table-hover align-middle">
        <thead class="table-secondary">
            <tr>
                <th>ID</th>
                <th>ì´ë¦„</th>
                <th>ì£¼ì†Œ</th>
                <th>ì§€ì—­</th>
                <th>ìƒíƒœ</th>
                <th>ë°°ì†¡ ìƒíƒœ</th>
                <th>Wishlist</th>
                <th>ì„¤ëª…</th>
                <th>ì‘ì—…</th>
            </tr>
        </thead>
        <tbody id="childTableBody"></tbody>
    </table>

</div>

<!-- ğŸ Wishlist ëª¨ë‹¬ -->
<div class="modal fade" id="wishlistModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Wishlist ìƒì„¸ë³´ê¸°</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <table class="table table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th>ìš°ì„ ìˆœìœ„</th>
                            <th>Gift ID</th>
                            <th>ë¹„ê³ </th>
                        </tr>
                    </thead>
                    <tbody id="wishlistTableBody"></tbody>
                </table>
            </div>

        </div>
    </div>
</div>

<!-- ğŸ“ Note ìˆ˜ì • ëª¨ë‹¬ -->
<div class="modal fade" id="noteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">ì•„ì´ ì„¤ëª… ìˆ˜ì •</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <textarea id="noteInput" class="form-control" rows="6"></textarea>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="saveNote()">ì €ì¥</button>
            </div>

        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
const BASE_URL = "http://127.0.0.1:8000";

let childrenData = [];
let regions = [];
let currentEditChildId = null;

/* -------------------------
   Region ë¶ˆëŸ¬ì˜¤ê¸°
------------------------- */
async function loadRegions() {
    const res = await fetch(`${BASE_URL}/regions/all`);
    regions = await res.json();

    const filter = document.getElementById("regionFilter");
    regions.forEach(r => {
        filter.innerHTML += `<option value="${r.RegionID}">${r.RegionName}</option>`;
    });
}

/* -------------------------
   Child ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
------------------------- */
async function loadChildren() {
    const res = await fetch(`${BASE_URL}/list-elf/child/all`);
    childrenData = await res.json();
    renderChildren();
}

/* -------------------------
   Child í…Œì´ë¸” ë Œë”ë§
------------------------- */
function renderChildren() {
    const keyword = document.getElementById("searchInput").value.trim();
    const regionValue = document.getElementById("regionFilter").value;

    const tbody = document.getElementById("childTableBody");
    tbody.innerHTML = "";

    let nice=0, naughty=0, pending=0;

    childrenData
        .filter(c => (!keyword || c.name.includes(keyword) || c.address.includes(keyword)))
        .filter(c => (!regionValue || c.region_id == regionValue))
        .forEach(c => {

            if (c.status_code === "NICE") nice++;
            else if (c.status_code === "NAUGHTY") naughty++;
            else pending++;

            const regionName = (regions.find(r => r.RegionID == c.region_id) || {}).RegionName || "(ë¯¸ì§€ì •)";

            tbody.innerHTML += `
                <tr>
                    <td>${c.child_id}</td>
                    <td>${c.name}</td>
                    <td>${c.address}</td>
                    <td>${regionName}</td>

                    <td>
                        <select class="form-select form-select-sm"
                                onchange="updateStatus(${c.child_id}, this.value)">
                            <option value="PENDING" ${c.status_code==="PENDING"?"selected":""}>PENDING</option>
                            <option value="NICE" ${c.status_code==="NICE"?"selected":""}>NICE</option>
                            <option value="NAUGHTY" ${c.status_code==="NAUGHTY"?"selected":""}>NAUGHTY</option>
                        </select>
                    </td>

                    <td>
                        <span class="badge bg-${c.delivery_status_code === "DELIVERED" ? "primary" : "secondary"}">
                            ${c.delivery_status_code}
                        </span>
                    </td>

                    <td>
                        <button class="btn btn-info btn-sm" onclick="openWishlistModal('${c.child_id}')">
                            ğŸ ë³´ê¸°
                        </button>
                    </td>

                    <td>
                        <button class="btn btn-outline-secondary btn-sm" onclick="openNoteModal(${c.child_id})">
                            ë³´ê¸°/ìˆ˜ì •
                        </button>
                    </td>

                    <td>
                        <button class="btn btn-danger btn-sm" onclick="deleteChild(${c.child_id})">ì‚­ì œ</button>
                    </td>
                </tr>
            `;
        });

    document.getElementById("countNice").innerText = nice;
    document.getElementById("countNaughty").innerText = naughty;
    document.getElementById("countPending").innerText = pending;
}

/* -------------------------
   ğŸ Wishlist ëª¨ë‹¬
   â†’ /list-elf/child/{id}/details ì‚¬ìš©
------------------------- */
async function openWishlistModal(childId) {
    const res = await fetch(`${BASE_URL}/list-elf/child/${childId}/wishlist`);
    const data = await res.json();

    const tbody = document.getElementById("wishlistTableBody");
    tbody.innerHTML = "";

    data.wishlist.forEach(item => {
        tbody.innerHTML += `
            <tr class="priority-${item.priority}">
                <td>${item.priority}</td>
                <td>${item.gift_id}</td>
                <td>${item.gift_name}</td>
            </tr>
        `;
    });

    new bootstrap.Modal(document.getElementById("wishlistModal")).show();
}


/* -------------------------
   ğŸ“ Note ëª¨ë‹¬
------------------------- */
function openNoteModal(childId) {
    currentEditChildId = childId;

    const child = childrenData.find(c => c.child_id === childId);
    document.getElementById("noteInput").value = child.child_note || "";

    new bootstrap.Modal(document.getElementById("noteModal")).show();
}

/* -------------------------
   Note ì €ì¥
------------------------- */
async function saveNote() {
    const note = document.getElementById("noteInput").value;

    await fetch(`${BASE_URL}/list-elf/child/${currentEditChildId}`, {
        method: "PATCH",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ child_note: note })
    });

    loadChildren();
    bootstrap.Modal.getInstance(document.getElementById("noteModal")).hide();
}

/* -------------------------
   Child ì‚­ì œ
------------------------- */
async function deleteChild(childId) {
    if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    await fetch(`${BASE_URL}/list-elf/child/${childId}`, {
        method: "DELETE"
    });

    loadChildren();
}

/* -------------------------
   ìƒíƒœ ë³€ê²½
------------------------- */
async function updateStatus(childId, newStatus) {
    await fetch(`${BASE_URL}/list-elf/child/${childId}`, {
        method: "PATCH",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ status_code: newStatus })
    });

    loadChildren();
}

/* -------------------------
   ì´ˆê¸° ì‹¤í–‰
------------------------- */
(async function init() {
    await loadRegions();
    await loadChildren();
})();
</script>

</body>
</html>
