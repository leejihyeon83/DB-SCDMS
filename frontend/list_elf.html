<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ListElf - ì•„ì´ ëª©ë¡</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>

    <style>
        :root {
            --scdms-gold: #F5C542;          /* ë©”ì¸ ê³¨ë“œ */
            --scdms-gold-dark: #D9A620;     /* ë‹¤í¬ ê³¨ë“œ */
            --scdms-gold-bg: #FFF7D6;       /* ì—°í•œ ë°°ê²½ */
        }

        body {
            background: radial-gradient(circle at top, #FFF7D6 0, #FFF7D6 45%, #FFF7D6 100%);
            min-height: 100vh;
        }

        /* ìƒë‹¨ ìœ ì € ì •ë³´ ë°” */
        #user-info-bar {
            padding: 10px 16px;
            background: #f3f4f6;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.9rem;
        }

        .user-info-inner {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 960px;
            margin: 0 auto;
        }

        .user-label {
            color: #374151;
        }

        .role-badge {
            display: inline-block;
            margin-left: 6px;
            padding: 2px 8px;
            border-radius: 999px;
            background: #fee2e2;
            color: #b91c1c;
            font-size: 0.8rem;
        }

        .logout-button {
            padding: 6px 10px;
            border-radius: 999px;
            border: none;
            background: #ef4444;
            color: #fff;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .logout-button:hover {
            background: #dc2626;
        }

        /* ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ */
        .scdms-navbar {
            background: var(--scdms-gold);
        }
        .scdms-navbar .navbar-brand {
            font-weight: 700;
        }
        .scdms-navbar .brand-icon {
            margin-right: 6px;
        }

        /* ìƒë‹¨ íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */
        .scdms-tabs {
            background: var(--scdms-gold-bg);
            border-bottom: 1px solid #E8D9A8;
        }
        .scdms-tabs .nav-link {
            border-radius: 999px;
            padding: 8px 20px;
            margin-right: 8px;
            font-weight: 600;
            color: #555;
        }
        .scdms-tabs .nav-link.active {
            background: var(--scdms-gold);
            color: #fff;
        }

        /* ë©”ì¸ ì¹´ë“œ */
        .scdms-card {
            background: #ffffff;
            border-radius: 18px;
            border: 1px solid #f0f0f0;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.04);
        }

        /* ìš”ì•½ ì¹´ë“œ */
        .summary-card {
            border-radius: 16px;
            padding: 14px 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .summary-card span.label {
            font-size: 0.9rem;
        }
        .summary-card span.value {
            font-size: 1.2rem;
        }

        .summary-nice {
            background: #e2f6e9;;
            border: 1px solid #c1e7cf;
        }
        .summary-naughty {
            background: #ffe6e3;
            border: 1px solid #f6b9b4;
        }
        .summary-pending {
            background: #fff8de;
            border: 1px solid #f0dfaa;
        }

        /* ìš°ì„ ìˆœìœ„ ìƒ‰ (Wishlist ëª¨ë‹¬ìš©) */
        .priority-1 { background: #fff3cd; }
        .priority-2 { background: #e2e3e5; }
        .priority-3 { background: #d4edda; }

        /* ë©”ì¸ ë²„íŠ¼ */
        .btn-main {
            background: var(--scdms-gold);
            border-color: var(--scdms-gold);
        }
        .btn-main:hover {
            background: var(--scdms-gold-dark);
            border-color: var(--scdms-gold-dark);
        }

    </style>

    <script src="/js/auth.js"></script>
    <script>
        // ì´ í˜ì´ì§€ëŠ” ListElfë§Œ ì ‘ê·¼
        const currentUser = requireRole(["ListElf"]);
    </script>
</head>

<body>
<!-- ğŸ”´ ìƒë‹¨ ê¸€ë¡œë²Œ ë„¤ë¹„ê²Œì´ì…˜ -->
<nav class="navbar navbar-expand-lg navbar-dark scdms-navbar">
    <div class="container-fluid px-4">
        <a class="navbar-brand d-flex align-items-center" href="#">
            <span class="brand-icon">ğŸ„</span>
            <span>SCDMS Â· ëª…ë‹¨ ê´€ë¦¬ ìš”ì²­ ì œì–´ì„¼í„°</span>
        </a>
        <div class="d-flex align-items-center">
            <span class="badge bg-light text-dark me-3">ListElf</span>
            <button type="button" class="btn btn-outline-light btn-sm" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>
</nav>

<!-- ğŸ”´ ìƒë‹¨ íƒ­ (ì—­í•  ë‚´ ë©”ë‰´) -->
<div class="scdms-tabs">
    <div class="container px-4">
        <ul class="nav py-3">
            <li class="nav-item">
                <a class="nav-link active" href="/list_elf.html">ì•„ì´ ëª©ë¡</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/add_child.html">ì•„ì´ ë“±ë¡</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/rules.html">ê·œì¹™ ê´€ë¦¬</a>
            </li>
        </ul>
    </div>
</div>

<!-- ğŸ“¦ ë©”ì¸ ì½˜í…ì¸  -->
<div class="container px-4 py-4">
    <div class="scdms-card p-4 p-md-5">

        <!-- íƒ€ì´í‹€ -->
        <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-md-between mb-4">
            <div>
                <h2 class="fw-bold mb-1">ì•„ì´ ëª©ë¡</h2>
                <p class="text-muted mb-0">ë…¸ìŠ¤í´ ì‹œìŠ¤í…œì— ë“±ë¡ëœ ëª¨ë“  ì•„ì´ë“¤ì„ í™•ì¸í•˜ê³  ê´€ë¦¬í•´ìš”.</p>
            </div>
            <div class="mt-3 mt-md-0">
                <a href="/add_child.html" class="btn btn-main">
                    + ìƒˆ ì•„ì´ ë“±ë¡
                </a>
            </div>
        </div>

        <!-- ê²€ìƒ‰ + ì§€ì—­ í•„í„° -->
        <div class="row g-2 mb-4">
            <div class="col-md-6">
                <input id="searchInput" class="form-control" placeholder="ì´ë¦„ ë˜ëŠ” ì£¼ì†Œ ê²€ìƒ‰â€¦" />
            </div>
            <div class="col-md-3">
                <select id="regionFilter" class="form-select" onchange="renderChildren()">
                    <option value="">ì „ì²´ ì§€ì—­</option>
                </select>
            </div>
            <div class="col-md-3">
                <button class="btn btn-outline-secondary w-100" onclick="loadChildren()">ê²€ìƒ‰ / ìƒˆë¡œê³ ì¹¨</button>
            </div>
        </div>

        <!-- ìš”ì•½ íŒ¨ë„ -->
        <div class="row g-3 mb-4">
            <div class="col-md-4">
                <div class="summary-card summary-nice">
                    <span class="label">ì°©í•œ ì•„ì´ë“¤</span>
                    <span class="value" id="countNice">0</span>
                </div>
            </div>
            <div class="col-md-4">
                <div class="summary-card summary-naughty">
                    <span class="label">ë‚˜ìœ ì•„ì´ë“¤</span>
                    <span class="value" id="countNaughty">0</span>
                </div>
            </div>
            <div class="col-md-4">
                <div class="summary-card summary-pending">
                    <span class="label">ì‹¬ì‚¬ ëŒ€ê¸° ì¤‘</span>
                    <span class="value" id="countPending">0</span>
                </div>
            </div>
        </div>

        <!-- ì•„ì´ í…Œì´ë¸” -->
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-secondary">
                    <tr>
                        <th>ID</th>
                        <th>ì´ë¦„</th>
                        <th>ì£¼ì†Œ</th>
                        <th>ì§€ì—­</th>
                        <th>ìƒíƒœ</th>
                        <th>ë°°ì†¡ ìƒíƒœ</th>
                        <th>Wishlist</th>
                        <th>ì„¤ëª…</th>
                        <th>ì‘ì—…</th>
                    </tr>
                </thead>
                <tbody id="childTableBody"></tbody>
            </table>
        </div>

    </div>
</div>

<!-- ğŸ Wishlist ëª¨ë‹¬ -->
<div class="modal fade" id="wishlistModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Wishlist ìƒì„¸ë³´ê¸°</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <table class="table table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th>ìš°ì„ ìˆœìœ„</th>
                            <th>Gift ID</th>
                            <th>ì„ ë¬¼ ì´ë¦„</th>
                        </tr>
                    </thead>
                    <tbody id="wishlistTableBody"></tbody>
                </table>
            </div>

        </div>
    </div>
</div>

<!-- ğŸ“ Note ìˆ˜ì • ëª¨ë‹¬ -->
<div class="modal fade" id="noteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">ì•„ì´ ì„¤ëª… ìˆ˜ì •</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <textarea id="noteInput" class="form-control" rows="6"></textarea>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button class="btn btn-main" onclick="saveNote()">ì €ì¥</button>
            </div>

        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="./js/ex.js"></script>
<script>
const BASE_URL = "http://127.0.0.1:8000";

let childrenData = [];
let regions = [];
let currentEditChildId = null;

/* -------------------------
   Region ë¶ˆëŸ¬ì˜¤ê¸°
------------------------- */
async function loadRegions() {
    const res = await fetch(`${BASE_URL}/regions/all`);
    regions = await res.json();

    const filter = document.getElementById("regionFilter");
    filter.innerHTML = '<option value="">ì „ì²´ ì§€ì—­</option>';

    regions.forEach(r => {
        filter.innerHTML += `<option value="${r.RegionID}">${r.RegionName}</option>`;
    });
}

/* -------------------------
   Child ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
------------------------- */
async function loadChildren() {
    const res = await fetch(`${BASE_URL}/list-elf/child/all`);
    childrenData = await res.json();
    renderChildren();
}

/* -------------------------
   Child í…Œì´ë¸” ë Œë”ë§
------------------------- */
function renderChildren() {
    const keyword = document.getElementById("searchInput").value.trim();
    const regionValue = document.getElementById("regionFilter").value;

    const tbody = document.getElementById("childTableBody");
    tbody.innerHTML = "";

    let nice=0, naughty=0, pending=0;

    childrenData
        .filter(c => (!keyword || c.name.includes(keyword) || c.address.includes(keyword)))
        .filter(c => (!regionValue || c.region_id == regionValue))
        .forEach(c => {

            if (c.status_code === "NICE") nice++;
            else if (c.status_code === "NAUGHTY") naughty++;
            else pending++;

            const regionName = (regions.find(r => r.RegionID == c.region_id) || {}).RegionName || "(ë¯¸ì§€ì •)";

            tbody.innerHTML += `
                <tr>
                    <td>${c.child_id}</td>
                    <td>${c.name}</td>
                    <td>${c.address}</td>
                    <td>${regionName}</td>

                    <td>
                        <select class="form-select form-select-sm"
                                onchange="updateStatus(${c.child_id}, this.value)">
                            <option value="PENDING" ${c.status_code==="PENDING"?"selected":""}>PENDING</option>
                            <option value="NICE" ${c.status_code==="NICE"?"selected":""}>NICE</option>
                            <option value="NAUGHTY" ${c.status_code==="NAUGHTY"?"selected":""}>NAUGHTY</option>
                        </select>
                    </td>

                    <td>
                        <span class="badge bg-${c.delivery_status_code === "DELIVERED" ? "primary" : "secondary"}">
                            ${c.delivery_status_code}
                        </span>
                    </td>

                    <td>
                        <button class="btn btn-info btn-sm" onclick="openWishlistModal('${c.child_id}')">
                            ğŸ ë³´ê¸°
                        </button>
                    </td>

                    <td>
                        <button class="btn btn-outline-secondary btn-sm" onclick="openNoteModal(${c.child_id})">
                            ë³´ê¸°/ìˆ˜ì •
                        </button>
                    </td>

                    <td>
                        <button class="btn btn-danger btn-sm" onclick="deleteChild(${c.child_id})">ì‚­ì œ</button>
                    </td>
                </tr>
            `;
        });

    document.getElementById("countNice").innerText = nice;
    document.getElementById("countNaughty").innerText = naughty;
    document.getElementById("countPending").innerText = pending;
}

/* -------------------------
   ğŸ Wishlist ëª¨ë‹¬
------------------------- */
async function openWishlistModal(childId) {
    const res = await fetch(`${BASE_URL}/list-elf/child/${childId}/wishlist`);
    const data = await res.json();

    const tbody = document.getElementById("wishlistTableBody");
    tbody.innerHTML = "";

    data.wishlist.forEach(item => {
        tbody.innerHTML += `
            <tr class="priority-${item.priority}">
                <td>${item.priority}</td>
                <td>${item.gift_id}</td>
                <td>${item.gift_name}</td>
            </tr>
        `;
    });

    new bootstrap.Modal(document.getElementById("wishlistModal")).show();
}


/* -------------------------
   ğŸ“ Note ëª¨ë‹¬
------------------------- */
function openNoteModal(childId) {
    currentEditChildId = childId;

    const child = childrenData.find(c => c.child_id === childId);
    document.getElementById("noteInput").value = child.child_note || "";

    new bootstrap.Modal(document.getElementById("noteModal")).show();
}

/* -------------------------
   Note ì €ì¥
------------------------- */
async function saveNote() {
    const note = document.getElementById("noteInput").value;

    await fetch(`${BASE_URL}/list-elf/child/${currentEditChildId}`, {
        method: "PATCH",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ child_note: note })
    });

    loadChildren();
    bootstrap.Modal.getInstance(document.getElementById("noteModal")).hide();
}

/* -------------------------
   Child ì‚­ì œ
------------------------- */
async function deleteChild(childId) {
    if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    await fetch(`${BASE_URL}/list-elf/child/${childId}`, {
        method: "DELETE"
    });

    loadChildren();
}

/* -------------------------
   ìƒíƒœ ë³€ê²½
------------------------- */
async function updateStatus(childId, newStatus) {
    await fetch(`${BASE_URL}/list-elf/child/${childId}`, {
        method: "PATCH",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ status_code: newStatus })
    });

    loadChildren();
}

/* -------------------------
   ì´ˆê¸° ì‹¤í–‰
------------------------- */
(async function init() {
    await loadRegions();
    await loadChildren();
})();
</script>

</body>
</html>